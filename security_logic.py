from dataclasses import dataclass
from typing import List, Dict, Iterable


@dataclass(frozen=True)
class Measure:
    code: str
    section: str
    description: str
    levels: List[int]


BASE_REQUIREMENTS: Dict[int, List[str]] = {
    4: [
        "Организуйте режим обеспечения безопасности помещений, в которых размещена информационная система, препятствующего возможности неконтролируемого проникновения или пребывания в этих помещениях лиц, не имеющих права доступа в эти помещения;",
        "Обеспечьте сохранность носителей персональных данных.",
        "Утвердите перечень сотрудников, чьи полномочия требуют доступа к ПДн.",
        "Применяйте сертифицированные средства защиты, если они необходимы для нейтрализации актуальных угроз.",
    ],
    3: [
        "Назначьте должностное лицо, ответственное за безопасность ПДн в системе.",
    ],
    2: [
        "Ограничьте доступ к электронному журналу сообщений только уполномоченными лицами.",
    ],
    1: [
        "Автоматически фиксируйте изменения полномочий сотрудников в журнале безопасности.",
        "Создайте подразделение или возложите на существующее функции обеспечения безопасности ПДн.",
    ],
}


MEASURES: List[Measure] = [
    # I. Идентификация и аутентификация (ИАФ)
    Measure("ИАФ.1", "Идентификация и аутентификация", "Идентификация и аутентификация пользователей — работников оператора.", [1, 2, 3, 4]),
    Measure("ИАФ.2", "Идентификация и аутентификация", "Идентификация и аутентификация устройств (стационарных, мобильных, портативных).", [1, 2]),
    Measure("ИАФ.3", "Идентификация и аутентификация", "Управление идентификаторами: создание, присвоение, уничтожение.", [1, 2, 3, 4]),
    Measure("ИАФ.4", "Идентификация и аутентификация", "Управление средствами аутентификации и действиями при их компрометации.", [1, 2, 3, 4]),
    Measure("ИАФ.5", "Идентификация и аутентификация", "Защита обратной связи при вводе аутентификационной информации.", [1, 2, 3, 4]),
    Measure("ИАФ.6", "Идентификация и аутентификация", "Идентификация и аутентификация внешних пользователей.", [1, 2, 3, 4]),
    # II. Управление доступом (УПД)
    Measure("УПД.1", "Управление доступом", "Управление учетными записями пользователей, включая внешних.", [1, 2, 3, 4]),
    Measure("УПД.2", "Управление доступом", "Реализация методов и правил разграничения доступа.", [1, 2, 3, 4]),
    Measure("УПД.3", "Управление доступом", "Управление информационными потоками между устройствами и сегментами.", [1, 2, 3, 4]),
    Measure("УПД.4", "Управление доступом", "Разделение полномочий пользователей, администраторов и операторов.", [1, 2, 3, 4]),
    Measure("УПД.5", "Управление доступом", "Минимизация прав и привилегий пользователей и администраторов.", [1, 2, 3, 4]),
    Measure("УПД.6", "Управление доступом", "Ограничение неуспешных попыток входа в систему.", [1, 2, 3, 4]),
    Measure("УПД.10", "Управление доступом", "Блокирование сеанса после периода бездействия или по запросу пользователя.", [1, 2, 3]),
    Measure("УПД.11", "Управление доступом", "Настройка разрешенных действий до идентификации и аутентификации.", [1, 2, 3]),
    Measure("УПД.13", "Управление доступом", "Реализация защищенного удаленного доступа через внешние сети.", [1, 2, 3, 4]),
    Measure("УПД.14", "Управление доступом", "Контроль использования беспроводных технологий.", [1, 2, 3, 4]),
    Measure("УПД.15", "Управление доступом", "Контроль использования мобильных технических средств.", [1, 2, 3, 4]),
    Measure("УПД.16", "Управление доступом", "Управление взаимодействием с внешними информационными системами.", [1, 2, 3, 4]),
    Measure("УПД.17", "Управление доступом", "Обеспечение доверенной загрузки средств вычислительной техники.", [1, 2]),
    # III. Ограничение программной среды (ОПС)
    Measure("ОПС.2", "Ограничение программной среды", "Управление установкой компонентов программного обеспечения.", [1, 2]),
    Measure("ОПС.3", "Ограничение программной среды", "Установка только разрешенного к использованию программного обеспечения.", [1]),
    # IV. Защита машинных носителей (ЗНИ)
    Measure("ЗНИ.1", "Защита машинных носителей", "Учет машинных носителей персональных данных.", [1, 2]),
    Measure("ЗНИ.2", "Защита машинных носителей", "Управление доступом к машинным носителям персональных данных.", [1, 2]),
    Measure("ЗНИ.8", "Защита машинных носителей", "Стирание или обезличивание ПДн при передаче носителей, контроль уничтожения.", [1, 2, 3]),
    # V. Регистрация событий безопасности (РСБ)
    Measure("РСБ.1", "Регистрация событий", "Определение событий безопасности для регистрации и сроков хранения.", [1, 2, 3, 4]),
    Measure("РСБ.2", "Регистрация событий", "Определение состава информации о событиях безопасности.", [1, 2, 3, 4]),
    Measure("РСБ.3", "Регистрация событий", "Сбор, запись и хранение информации о событиях безопасности.", [1, 2, 3, 4]),
    Measure("РСБ.5", "Регистрация событий", "Мониторинг и реагирование на зарегистрированные события безопасности.", [1, 2]),
    Measure("РСБ.7", "Регистрация событий", "Защита информации о событиях безопасности.", [1, 2, 3, 4]),
    # VI. Антивирусная защита (АВЗ)
    Measure("АВЗ.1", "Антивирусная защита", "Реализация антивирусной защиты.", [1, 2, 3, 4]),
    Measure("АВЗ.2", "Антивирусная защита", "Обновление баз данных признаков вредоносных программ.", [1, 2, 3, 4]),
    # VII. Обнаружение вторжений (СОВ)
    Measure("СОВ.1", "Обнаружение вторжений", "Реализация обнаружения вторжений.", [1, 2]),
    Measure("СОВ.2", "Обнаружение вторжений", "Обновление базы решающих правил систем обнаружения вторжений.", [1, 2]),
    # VIII. Контроль защищенности (АНЗ)
    Measure("АНЗ.1", "Контроль защищенности", "Выявление и устранение уязвимостей информационной системы.", [1, 2, 3]),
    Measure("АНЗ.2", "Контроль защищенности", "Контроль установки обновлений ПО и средств защиты.", [1, 2, 3, 4]),
    Measure("АНЗ.3", "Контроль защищенности", "Контроль работоспособности и корректности настройки ПО и СЗИ.", [1, 2, 3]),
    Measure("АНЗ.4", "Контроль защищенности", "Контроль состава технических средств, ПО и СЗИ.", [1, 2, 3]),
    Measure("АНЗ.5", "Контроль защищенности", "Контроль правил генерации и смены паролей и разграничения доступа.", [1, 2]),
    # IX. Обеспечение целостности (ОЦЛ)
    Measure("ОЦЛ.1", "Целостность", "Контроль целостности программного обеспечения, включая СЗИ.", [1, 2]),
    Measure("ОЦЛ.4", "Целостность", "Защита от спама и незапрашиваемых сообщений.", [1, 2]),
    # X. Обеспечение доступности (ОДТ)
    Measure("ОДТ.3", "Доступность", "Контроль безотказного функционирования технических средств и восстановление после отказов.", [1]),
    Measure("ОДТ.4", "Доступность", "Периодическое резервное копирование ПДн на резервные носители.", [1, 2]),
    Measure("ОДТ.5", "Доступность", "Возможность восстановления ПДн с резервных копий в заданные сроки.", [1, 2]),
    # XI. Защита среды виртуализации (ЗСВ)
    Measure("ЗСВ.1", "Защита среды виртуализации", "Идентификация и аутентификация в виртуальной инфраструктуре.", [1, 2, 3, 4]),
    Measure("ЗСВ.2", "Защита среды виртуализации", "Управление доступом внутри виртуальной инфраструктуры.", [1, 2, 3, 4]),
    Measure("ЗСВ.3", "Защита среды виртуализации", "Регистрация событий безопасности в виртуальной инфраструктуре.", [1, 2, 3]),
    Measure("ЗСВ.6", "Защита среды виртуализации", "Управление перемещением виртуальных машин и данных.", [1, 2]),
    Measure("ЗСВ.7", "Защита среды виртуализации", "Контроль целостности виртуальной инфраструктуры и конфигураций.", [1, 2]),
    Measure("ЗСВ.8", "Защита среды виртуализации", "Резервирование данных и компонентов виртуальной инфраструктуры.", [1, 2]),
    Measure("ЗСВ.9", "Защита среды виртуализации", "Антивирусная защита в виртуальной инфраструктуре.", [1, 2, 3]),
    Measure("ЗСВ.10", "Защита среды виртуализации", "Сегментирование виртуальной инфраструктуры по пользователям или группам.", [1, 2, 3]),
    # XII. Защита технических средств (ЗТС)
    Measure("ЗТС.3", "Защита технических средств", "Контроль и управление физическим доступом к техническим средствам и помещениям.", [1, 2, 3, 4]),
    Measure("ЗТС.4", "Защита технических средств", "Безопасное размещение устройств вывода информации.", [1, 2, 3, 4]),
    # XIII. Защита информационной системы (ЗИС)
    Measure("ЗИС.1", "Защита информационной системы", "Разделение функций управления системой и обработки ПДн.", [1]),
    Measure("ЗИС.3", "Защита информационной системы", "Защита ПДн при передаче по каналам связи, включая беспроводные.", [1, 2, 3, 4]),
    Measure("ЗИС.11", "Защита информационной системы", "Обеспечение подлинности сетевых соединений и защита от подмены.", [1, 2]),
    Measure("ЗИС.15", "Защита информационной системы", "Защита архивных файлов, настроек СЗИ и иных неизменяемых данных.", [1, 2]),
    Measure("ЗИС.17", "Защита информационной системы", "Сегментирование информационной системы и защита периметров сегментов.", [1, 2]),
    Measure("ЗИС.20", "Защита информационной системы", "Защита беспроводных соединений, применяемых в системе.", [1, 2, 3]),
    # XIV. Выявление инцидентов (ИНЦ)
    Measure("ИНЦ.1", "Выявление инцидентов", "Назначение ответственных за выявление и реагирование на инциденты.", [1, 2]),
    Measure("ИНЦ.2", "Выявление инцидентов", "Обнаружение, идентификация и регистрация инцидентов.", [1, 2]),
    Measure("ИНЦ.3", "Выявление инцидентов", "Информирование ответственных лиц о возникновении инцидентов.", [1, 2]),
    Measure("ИНЦ.4", "Выявление инцидентов", "Анализ инцидентов и оценка последствий.", [1, 2]),
    Measure("ИНЦ.5", "Выявление инцидентов", "Устранение последствий инцидентов.", [1, 2]),
    Measure("ИНЦ.6", "Выявление инцидентов", "Предотвращение повторного возникновения инцидентов.", [1, 2]),
    # XV. Управление конфигурацией (УКФ)
    Measure("УКФ.1", "Управление конфигурацией", "Определение лиц, которым разрешены изменения конфигурации ИС и СЗПДн.", [1, 2, 3]),
    Measure("УКФ.2", "Управление конфигурацией", "Управление изменениями конфигурации ИС и СЗПДн.", [1, 2, 3]),
    Measure("УКФ.3", "Управление конфигурацией", "Анализ влияния изменений на защиту ПДн и согласование с ответственным за безопасность.", [1, 2, 3]),
    Measure("УКФ.4", "Управление конфигурацией", "Документирование изменений конфигурации ИС и СЗПДн.", [1, 2, 3]),
]


def determine_level(
    data_type: str,
    threats: Iterable[str],
    employees_only: bool,
    non_employee_scope: str | None,
) -> int:
    normalized_threats = {t for t in threats if t}
    normalized_threats.discard("unknown")

    def has(threat_type: str) -> bool:
        return threat_type in normalized_threats

    over_100k = non_employee_scope == "over_100k"
    under_100k = non_employee_scope == "under_100k"

    # Level 1
    if has("1") and data_type in {"special", "biometric", "other"}:
        return 1
    if has("2") and data_type == "special" and not employees_only and over_100k:
        return 1

    # Level 2
    if has("1") and data_type == "public":
        return 2
    if has("2") and data_type == "special" and (employees_only or under_100k):
        return 2
    if has("2") and data_type == "biometric":
        return 2
    if has("2") and data_type == "public" and over_100k:
        return 2
    if has("2") and data_type == "other" and over_100k:
        return 2
    if has("3") and data_type == "special" and not employees_only and over_100k:
        return 2

    # Level 3
    if has("2") and data_type == "public" and (employees_only or under_100k):
        return 3
    if has("2") and data_type == "other" and (employees_only or under_100k):
        return 3
    if has("3") and data_type == "special" and (employees_only or under_100k):
        return 3
    if has("3") and data_type == "biometric":
        return 3
    if has("3") and data_type == "other" and not employees_only and over_100k:
        return 3

    # Level 4
    if has("3") and data_type == "public":
        return 4
    if has("3") and data_type == "other" and (employees_only or under_100k):
        return 4

    # Default minimal recommendations
    return 4


def get_base_requirements(level: int) -> List[str]:
    requirements: List[str] = []
    for current_level in [4, 3, 2, 1]:
        if level <= current_level:
            requirements.extend(BASE_REQUIREMENTS.get(current_level, []))
    return requirements


def get_measures_for_level(level: int) -> List[Measure]:
    return [measure for measure in MEASURES if level in measure.levels]
